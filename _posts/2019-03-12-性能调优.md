# 概要

性能监控一般分为


性能调优

Throughput和Latency的权衡


throughput和latency是两个相关联的量。一般减少延时，就会降低吞吐量。提高延时，就会提高吞吐。

查看操作系统负载

cpu负载	CPU的利用率还要看内核态的和用户态的，内核态的一上去了，整个系统的性能就下来了。而对于多核CPU来说，CPU 0 是相当关键的，如果CPU 0的负载高，那么会影响其它核的性能，因为CPU各核间是需要有调度的，这靠CPU0完成
io负载


# 工具箱

## 操作系统工具

windows下用[windows Sysinternals](https://docs.microsoft.com/zh-cn/sysinternals/)一整套的工具就好了。包括process exploer,process monitor等。都可以对操作系统的性能做很好的监控。

linux下的`sar`是比较全面的性能分析工具，包括iostat，vmstat。


### cpu使用率

cpu作为程序执行的主体，分析cpu的工具比较多，`perf`,`top`,`vmstat`,`VTune`
`perf`非常强大的性能分析工具。甚至能对cache miss和内核切换做分析。

运行队列：运行队列大于处理器个数 代表cpu执行不过来了

### 磁盘使用率

### 磁盘利用率，磁盘队列
`iostat -xm 1`每秒查看磁盘的读写量。`-x`显示更详细的统计信息，`-m`用megabytes为单位显示统计信息。

关注写入速度，await时间等。

```Cmd
avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.25    0.00    0.38    0.12    0.00   99.25

Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
vda               0.00     0.00    0.00   18.00     0.00     0.04     4.00     0.03    1.83    0.00    1.83   0.67   1.20
vdb               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00
```

### 内存

`vmstat`的`si`代表换入，`so`代表换出。正在内存交换的系统性能很差。

```Cmd
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 0  0      0 6288620  75888 349184    0    0     0     3    0    0  0  0 100  0  0
 0  0      0 6288480  75888 349184    0    0     0     0  844 1664  0  0 100  0  0
```

`netstat -s # 查看网络统计信息`
`netstat -anotp` 查看所有tcp链接，`p`显示pid。`n`显示原始地址，不用试图解析。`o`包括网络计时器。

Recv-Q和Send-Q 可以看TCP缓存区的情况。来断定是否TCP已经来不起接收或者发送。
```Cmd
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name     Timer
tcp        0      0 0.0.0.0:8060            0.0.0.0:*               LISTEN      15848/nginx: master  off (0.00/0/0)
tcp        0      0 127.0.0.1:9121          0.0.0.0:*               LISTEN      16470/redis_exporte  off (0.00/0/0)
tcp        0      0 192.168.2.207:30000     192.168.101.102:62645   ESTABLISHED 5546/mongod          keepalive (290.00/0/0)
tcp        0     28 10.0.0.14:10001         115.52.169.241:26370    ESTABLISHED 8427/java            on (79.60/5/0)
```



## 网络使用率

`ifconfig`，`netstat`，`ifstat`。


## java提供的工具

除了系统层面的监控数据。`热点方法`，`堆内存`等java相关的监控。就需要用到能对java程序分析的工具。

### jprofiler
jprofiler，收费工具，不过jprofiler 9有注册码可以破解。对热点方法，内存分配等，有全面的监控。也可以远程监控，不过要在服务器启动宁外的进程

### java visualVM(java misson control)
都是java自带的工具，可以通过建立JMX链接方便的监控远程服务器的状态。查看内存和MBAN等信息。启动的时候添加参数开启就好了`-Dcom.sun.management.jmxremote=true`。

JMX链接，会需要两个端口。连上后，会随机生成宁外的端口来监听指定进程。如果服务器有防火墙，可以指定两个固定端口`-Dcom.sun.management.jmxremote.port=yyyy -Dcom.sun.management.jmxremote.rmi.port=yyyy`。

java misson control和visualVM基本一样。多了java fight record，以sample的方式监控性能，本来打算作为商业功能，但jdk 11也计划免费。

### HPROF
HPROF: A Heap/CPU Profiling Tool (oracle) 需要启动的时候加参数
